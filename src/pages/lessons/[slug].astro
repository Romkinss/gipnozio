---
import { getCollection } from 'astro:content';
import LessonView from '../../components/LessonView';
import BreadcrumbsNav from '../../components/BreadcrumbsNav';
import '../../globals.css';

// Генерируем статические пути для всех уроков
export async function getStaticPaths() {
  const lessons = await getCollection('lessons');
  
  return lessons.map((lesson) => ({
    params: { slug: lesson.slug },
    props: { lesson },
  }));
}

interface Props {
  lesson: any;
}

const { lesson } = Astro.props;
const { Content } = await lesson.render();

// Получаем все уроки для навигации
const allLessons = await getCollection('lessons');
const sortedLessons = allLessons.sort((a, b) => a.data.order - b.data.order);

// Находим текущий урок и соседние
const currentIndex = sortedLessons.findIndex(l => l.slug === lesson.slug);
const previousLesson = currentIndex > 0 ? sortedLessons[currentIndex - 1] : null;
const nextLesson = currentIndex < sortedLessons.length - 1 ? sortedLessons[currentIndex + 1] : null;

// Подготавливаем HTML контента
const contentHtml = await Content.render();
---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{lesson.data.seo?.title || lesson.data.title} - GIPNOZIO</title>
    <meta name="description" content={lesson.data.seo?.description || lesson.data.description}>
    {lesson.data.seo?.keywords && (
        <meta name="keywords" content={lesson.data.seo.keywords.join(', ')}>
    )}
    <meta property="og:title" content={lesson.data.title}>
    <meta property="og:description" content={lesson.data.description}>
    <meta property="og:type" content="article">
    <meta property="og:url" content={`https://gipnozio.ru/lessons/${lesson.slug}`}>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="canonical" href={`https://gipnozio.ru/lessons/${lesson.slug}`}>
    
    <!-- Schema.org markup -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": "{lesson.data.title}",
        "description": "{lesson.data.description}",
        "duration": "{lesson.data.duration}",
        "educationLevel": "{lesson.data.level || 'All'}",
        "provider": {
            "@type": "Organization",
            "name": "GIPNOZIO",
            "logo": {
                "@type": "ImageObject",
                "url": "https://gipnozio.ru/logo.jpg"
            }
        }
    }
    </script>
</head>
<body class="bg-light text-dark-accent antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="/logo-gipnozio.jpg" alt="GIPNOZIO" class="h-10 w-10 rounded-full" />
                <span class="text-xl font-serif font-bold text-gold">GIPNOZIO</span>
            </div>
            <div class="hidden md:flex gap-8">
                <a href="/" class="text-dark hover:text-gold transition font-medium">Главная</a>
                <a href="/clients" class="text-dark hover:text-gold transition font-medium">Для Клиентов</a>
                <a href="/blog" class="text-dark hover:text-gold transition font-medium">Блог</a>
            </div>
            <a href="/login" class="hidden md:block px-6 py-2 bg-gold text-dark font-semibold rounded-lg hover:bg-dark hover:text-gold transition">
                ВХОД
            </a>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 py-12">
        <BreadcrumbsNav client:load items={[
            { label: 'Уроки', href: '/lessons' },
            { label: lesson.data.title, href: `/lessons/${lesson.slug}` }
        ]} />
        
        <LessonView 
            client:load
            title={lesson.data.title}
            description={lesson.data.description}
            duration={lesson.data.duration}
            level={lesson.data.level}
            module={lesson.data.module}
            objectives={lesson.data.objectives}
            content={contentHtml.html}
            videoUrl={lesson.data.videoUrl}
            resources={lesson.data.resources}
            previousLesson={previousLesson ? { slug: previousLesson.slug, title: previousLesson.data.title } : undefined}
            nextLesson={nextLesson ? { slug: nextLesson.slug, title: nextLesson.data.title } : undefined}
            progress={Math.round((currentIndex / sortedLessons.length) * 100)}
        />
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white py-12 border-t border-gold/20 mt-16">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <h3 class="text-gold font-serif font-bold mb-4 text-lg">GIPNOZIO</h3>
                    <p class="text-gray-400">Eurasian Academy of Hypnosis</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4 text-gold">Навигация</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="/" class="hover:text-gold transition">Главная</a></li>
                        <li><a href="/lessons" class="hover:text-gold transition">Уроки</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4 text-gold">Для Клиентов</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="/clients" class="hover:text-gold transition">Услуги</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4 text-gold">Контакты</h4>
                    <p class="text-gray-400">Roman Tretiakov</p>
                    <p class="text-gray-400 text-sm">Hypnotherapy Specialist</p>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-8 text-center text-gray-400">
                <p>&copy; 2024 GIPNOZIO Academy. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
